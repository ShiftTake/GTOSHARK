<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GTO Shark – Admin Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
    .card { background: #1e293b; }
  </style>
</head>

<body class="min-h-screen py-10">
  <div class="max-w-7xl mx-auto px-4">

    <h1 class="text-5xl font-extrabold text-center mb-10">
      GTO <span class="text-indigo-400">Shark</span> Admin
    </h1>

    <!-- Revenue Summary -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-10">
      <div class="card p-6 rounded-xl text-center">
        <p class="text-slate-400 text-sm">Today</p>
        <p class="text-3xl font-bold text-green-400" id="revToday">$0</p>
      </div>
      <div class="card p-6 rounded-xl text-center">
        <p class="text-slate-400 text-sm">Last 7 Days</p>
        <p class="text-3xl font-bold text-green-400" id="revWeek">$0</p>
      </div>
      <div class="card p-6 rounded-xl text-center">
        <p class="text-slate-400 text-sm">Last 30 Days</p>
        <p class="text-3xl font-bold text-green-400" id="revMonth">$0</p>
      </div>
      <div class="card p-6 rounded-xl text-center">
        <p class="text-slate-400 text-sm">This Year</p>
        <p class="text-3xl font-bold text-green-400" id="revYear">$0</p>
      </div>
      <div class="card p-6 rounded-xl text-center">
        <p class="text-slate-400 text-sm">All Time</p>
        <p class="text-3xl font-bold text-green-400" id="revAllTime">$0</p>
      </div>
    </div>

    <!-- Product Sales -->
    <div class="card p-6 rounded-xl mb-8">
      <h2 class="text-2xl font-bold mb-4">Sales by Product</h2>
      <div id="productSales" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <!-- User Search -->
    <div class="card p-6 rounded-xl mb-8">
      <input id="search" type="text" placeholder="Search by email..." class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg mb-4">
      <button onclick="loadUsers()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Refresh</button>
    </div>

    <!-- Users Table -->
    <div class="card rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-900">
            <tr>
              <th class="px-6 py-4 text-left">Email</th>
              <th class="px-6 py-4 text-left">Status</th>
              <th class="px-6 py-4 text-left">Registered</th>
              <th class="px-6 py-4 text-left">Subscription Start</th>
              <th class="px-6 py-4 text-left">Products</th>
              <th class="px-6 py-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="userTable"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
  // -----------------------------
  //  FIREBASE INIT
  // -----------------------------
  const firebaseConfig = {
    /* paste your REAL firebaseConfig here */
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const ADMIN_EMAIL = "your-admin-email@gmail.com";

  firebase.auth().signInWithEmailAndPassword(ADMIN_EMAIL, prompt("Admin Password:") || "")
    .catch(() => { alert("Access denied."); window.location = "/"; });

  // -----------------------------
  //  AUTO-CREATE USER DOC ON SIGNUP
  // -----------------------------
  firebase.auth().onAuthStateChanged(user => {
    if (!user || user.email !== ADMIN_EMAIL) return;

    console.log("Admin logged in.");
  });

  // -----------------------------
  //  LOAD USERS + REVENUE
  // -----------------------------
  async function loadUsers() {
    const query = document.getElementById("search").value.trim();

    let snap = query 
      ? await db.collection("users").where("email", ">=", query).where("email", "<=", query + "\uf8ff").get()
      : await db.collection("users").get();

    const tbody = document.getElementById("userTable");
    tbody.innerHTML = "";

    let totalRev = { today: 0, week: 0, month: 0, year: 0, all: 0 };
    const productCount = {};

    snap.forEach(doc => {
      const d = doc.data();

      const reg = d.registeredAt ? new Date(d.registeredAt.toDate()).toLocaleDateString() : "—";
      const subStart = d.subscriptionStart ? new Date(d.subscriptionStart.toDate()).toLocaleDateString() : "—";
      const status = d.hasAccess ? "ACTIVE" : "NO ACCESS";
      const color = d.hasAccess ? "text-green-400" : "text-red-400";

      // Revenue
      (d.payments || []).forEach(p => {
        const date = new Date(p.date);
        const amount = p.amount || 0;
        const now = new Date();

        if (date.toDateString() === now.toDateString()) totalRev.today += amount;
        if (date > new Date(now - 7*86400000)) totalRev.week += amount;
        if (date > new Date(now - 30*86400000)) totalRev.month += amount;
        if (date.getFullYear() === now.getFullYear()) totalRev.year += amount;

        totalRev.all += amount;

        // Product count
        if (p.product)
          productCount[p.product] = (productCount[p.product] || 0) + 1;
      });

      const row = document.createElement("tr");
      row.className = "border-t border-slate-700";

      row.innerHTML = `
        <td class="px-6 py-4">${d.email}</td>
        <td class="px-6 py-4"><span class="${color} font-bold">${status}</span></td>
        <td class="px-6 py-4">${reg}</td>
        <td class="px-6 py-4">${subStart}</td>
        <td class="px-6 py-4">${d.products?.join(", ") || "—"}</td>
        <td class="px-6 py-4 text-center space-x-2">
          
          <button onclick="toggleAccess('${doc.id}', ${!d.hasAccess})" 
            class="px-3 py-1 rounded ${d.hasAccess ? 'bg-red-600' : 'bg-green-600'} text-white text-xs">
            ${d.hasAccess ? "Revoke" : "Grant"}
          </button>

          <button onclick="addProduct('${doc.id}')" 
            class="px-3 py-1 rounded bg-indigo-600 text-white text-xs">
            + Product
          </button>

          <button onclick="addPayment('${doc.id}')" 
            class="px-3 py-1 rounded bg-yellow-600 text-white text-xs">
            + Payment
          </button>

        </td>
      `;

      tbody.appendChild(row);
    });

    document.getElementById("revToday").textContent = "$" + totalRev.today.toFixed(2);
    document.getElementById("revWeek").textContent = "$" + totalRev.week.toFixed(2);
    document.getElementById("revMonth").textContent = "$" + totalRev.month.toFixed(2);
    document.getElementById("revYear").textContent = "$" + totalRev.year.toFixed(2);
    document.getElementById("revAllTime").textContent = "$" + totalRev.all.toFixed(2);

    // Product breakdown
    const ps = document.getElementById("productSales");
    ps.innerHTML = Object.entries(productCount).map(([prod, count]) => `
      <div class="bg-slate-900 p-4 rounded-lg text-center">
        <p class="text-slate-400">${prod}</p>
        <p class="text-2xl font-bold text-indigo-400">${count} sales</p>
      </div>
    `).join("") || "<p class='text-center text-slate-500'>No sales yet</p>";
  }

  // -----------------------------
  //  ACTION BUTTONS
  // -----------------------------
  async function toggleAccess(uid, newState) {
    const update = { hasAccess: newState };

    // If granting access for the first time, set subscription start
    if (newState) update.subscriptionStart = firebase.firestore.FieldValue.serverTimestamp();

    await db.collection("users").doc(uid).update(update);
    loadUsers();
  }

  async function addProduct(uid) {
    const prod = prompt("Product name:");
    if (!prod) return;

    await db.collection("users").doc(uid).update({
      products: firebase.firestore.FieldValue.arrayUnion(prod)
    });

    loadUsers();
  }

  async function addPayment(uid) {
    const amount = parseFloat(prompt("Amount (USD):"));
    if (!amount) return;

    const product = prompt("Product related to this payment (optional):");

    await db.collection("users").doc(uid).update({
      payments: firebase.firestore.FieldValue.arrayUnion({
        amount,
        product: product || null,
        date: new Date().toISOString()
      })
    });

    loadUsers();
  }

  loadUsers();
  setInterval(loadUsers, 30000);
</script>

</body>
</html>
